{% extends 'guesswhich/base.html' %} {% block sidebar %} {% endblock %} {% block images %}
<div class="row">
    <div class="col s12 m9 l9 imagesParentContainer" id="imagesParentContainer">
        {% for i in img_list %}
        <div class="col s12 sampleImagesContainer mix" id="{{ i.img_id }}" data-score="{{ i.score }}">
            <img src="{{ i.image_path }}" class="sampleImage", height=200, width=175>
            <b class="imageRank"></b>
            <i class="large material-icons center red-text thumb_down_icon" style="display: none;">close</i>
            <a class="waves-effect waves-light btn blue selectImage center" style="display: none;">Select</a>
            <i class="large material-icons center green-text thumb_down_icon" style="display: none;">check</i>
            <!-- <a class="waves-effect waves-light btn red ignoreImage center" style="display: none;">Ignore</a> -->
            <b id="{{ i.img_id }}_score" class="imageScore"></b>
        </div>
        {% endfor %}
    </div>
    <div class="col s12 m3 l3">
        <div class="col s12 m3 l3 card chatBoxContainer">
            <div class="card-content ChatBoxCardContentDiv">
                <div class="messages">
                    {% for intro_message_part in bot_intro_message %}
                    <div class="row chat_bot_row">
                        <img src="{{static_data_dir}}/images/abot.png" width="40px" height="40px" class="square" align="left">
                        <div class="col s12 l10 left chat_bot">
                            <div class="card-panel black-text grey lighten-3">
                                <span class="black-text">{{ intro_message_part }}</span>
                            </div>
                        </div>
                    </div>
                    {% endfor %}

                </div>
                <div class="input-field messageInputField">
                    <input id="question" type="text" class="autocomplete" placeholder="Start typing question here ..." autocomplete="off">
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block message_typing %}



<!--IMPORTANT: This import contains all the functions you need to read in your input data and send back worker outputs.-->  
{% include "easyturk.html" %}


<script type="text/javascript">
// Initialize variables and configurations and state tracking
// '//' after each line indicates that variable is included in the final output to EasyTurk

    // Define global variables from input
    var show_feedback_modal = "{{ show_feedback_modal }}";
    var total_bonus_so_far = {{ total_bonus_so_far }};
    var current_finalround_bonus = {{ starting_final_bonus }}; //
    var bonus_deduction_on_each_click = {{ bonus_deduction_on_each_click }};
    var bonus_for_correct_image_after_each_round = {{ bonus_for_correct_image_after_each_round }};
    var targetImage = "{{ target_image }}";
    var targetImageId = "{{ target_image_id }}"; //
    var prev_history = "{{ caption }}";
    var num_of_games_in_a_hit = {{ num_of_games_in_a_hit }};
    var max_rounds = {{ max_rounds }};
    var post_endpoint = "{{ post_endpoint }}";
    var get_endpoint = "{{ get_endpoint }}";

    // Unused variables
    //var next_game_url = null;
    //var target_image_rank_list = [];
    //var ws_scheme = window.location.protocol == "https:" ? "wss" : "ws";
    //var current_user_sorting = {{ img_id_list | safe }};
    //var current_fc7_sorting = null;
    //var topImage = $(".sampleImagesContainer").first().attr("id");
    //var question_index = 0;
    //var current_question = "";
    //var current_answer = "";
    //var scores = {{ scores | safe}};


    // Initialize variables for reporting final task results, not used in task code
    var study_type = "{{ study_type }}" //
    var study_description = "{{ study_description }}" //
    var answerer_type = "{{ answerer_type }}" //
    var translator_type = "{{ translator_type }}" //
    var pool_index = "{{ pool_index }}" //
    var dialog_history = [] //
    var difficulty_level = "{{ difficulty_level }}" //
    var image_selections = []; //
    var final_output = null;
    var running_output = null;
    var total_payment = null; //

    // Initialize task tracking variables
    var pinwheel_bot_chat_div = null;
    var message_just_shown = false;
    var current_round = 0;
    var current_user_selected_image = null;
    var current_in_game_bonus = 0; //
    var finalImageSelected = false;
    var final_image_list = []; //

    // Initialize payment information in header nav bar
    var base_payment = {{ base_payment }};
    $("#base_payment").text(base_payment.toFixed(2));
    $("#remaining_finalround_bonus").text(current_finalround_bonus.toFixed(2));

    // Create necessary objects
    function initializeSpinner() {
        var spinner_opts = {
            lines: 13, // The number of lines to draw
            length: 38, // The length of each line
            width: 17, // The line thickness
            radius: 45, // The radius of the inner circle
            scale: 0.5, // Scales overall size of the spinner
            corners: 1, // Corner roundness (0..1)
            color: '#3B5998', // CSS color or array of colors
            fadeColor: 'transparent', // CSS color or array of colors
            speed: 0.9, // Rounds per second
            rotate: 0, // The rotation offset
            animation: 'spinner-line-fade-more', // The CSS animation name for the lines
            direction: 1, // 1: clockwise, -1: counterclockwise
            zIndex: 2e9, // The z-index (defaults to 2000000000)
            className: 'spinner', // The CSS class to assign to the spinner
            top: '90%', // Top position relative to parent
            left: '25%', // Left position relative to parent
            shadow: '0 0 1px transparent', // Box-shadow for the lines
            position: 'absolute' // Element positioning
        };
        var spinner = new Spinner(spinner_opts)
        return spinner
    }
    var spinner = initializeSpinner()

    // If debugging, configure extra information
    var debug_show_answer_string = "{{ debug_show_answer }}";
    if (debug_show_answer_string == "True") {
        var debug_show_answer = true;
    } else {
        var debug_show_answer = false;
    }

    var debug_logging_string = "{{ debug_logging }}";
    if (debug_logging_string == "True") {
        var debug_logging = true;
        console.log("Using verbose logging for debugging.")
    } else {
        var debug_logging = false;
    }

    var completed_hit_output = JSON.parse('{{ completed_hit_output }}');
    var url_prefix = "{{ url_prefix }}"


</script>

<script>
    // Define some default input.
    // It is good practice to define standard inputs for a task which will be overwritten when launching
    // your actual task. The default inputs allow you to render and debug your task locally.
    var DEFAULT_INPUT = [{"url": "https://cs.stanford.edu/people/rak248/VG_100K/1160052.jpg"},
                         {"url": "https://cs.stanford.edu/people/rak248/VG_100K/1160053.jpg"}]

   
    // Some variables to track state of the HIT.
    var idx = 0;
    var enabled = false;

    function main() {
        // If this is a HIT on AMT, then replace the default input with the real
        // input.
        input = easyturk.getInput(DEFAULT_INPUT);
        if (debug_logging) console.log("Retrieved input from EasyTurk: ", input);

        // Enable the task.
        if (!easyturk.isPreview()){
            if (debug_logging) console.log("Task enabled.");
            enableTask();
        }

        render();
    }

    // Use the current index to update the image and description
    function render() {

        // Refresh the counter
        $('.counter-top').text(idx + 1);
        $('.counter-bottom').text(input.length);

        // If the UI is enabled, enable or disable the buttons depending on
        // the index.
        /*
        if (enabled) {
          $('#prev-btn').prop('disabled', false);
          $('#next-btn').prop('disabled', false);
          if (idx == 0) {
            $('#prev-btn').prop('disabled', true);
          }
          if (idx == input.length - 1) {
            $('#next-btn').prop('disabled', true);
          }
        }
        */
    }

    // Update the index, and save the text in the text area.
    function setIdx(newIdx) {
        if (newIdx < 0 || newIdx >= input.length) return;
        idx = newIdx;
        render();
    }

    function taskComplete(verbose=false) {
        if (final_output == null) {
            if (verbose) alert("You haven't finished the dialog yet. Complete all {{ max_rounds }} turns to finish this task!")
            return false;
        } else {
            return true;
        }
    }

    // Enable the UI.
    function enableTask() {
        enabled = true;
        easyturk.setupSubmit();

        // Enable components
        $('#next-btn').click(function() {
            /*if (saveCaption()) {
                setIdx(idx + 1);
            }*/
            if (debug_logging) console.log("Hit EasyTurk next button");
            if (taskComplete(verbose=true)) {
              setIdx(idx+1)
            }
        });
        $('#prev-btn').click(function() {
            /*if (saveCaption()) {
                setIdx(idx - 1);
            }*/
            if (debug_logging) console.log("Hit EasyTurk prev button");
            if (taskComplete(verbose=true)) {
              setIdx(idx-1)
            }
        });
        //$('#submit-btn').prop('disabled', false);
        $('#submit-btn').prop('disabled', true);
        $('#submit-btn').hide()


        $('#submit-btn').click(function() {
            //output = {"foo": "bar"}
            if (!taskComplete(verbose=true)) {
                return false;
            }
            output = JSON.stringify(final_output)
            if (easyturk.isPreview()) {
                alert("This is only a preview. Here is your output: \n" + JSON.stringify(output));
                return false;
            } else {
                if (debug_logging) console.log("Sending HIT output via EasyTurk");
                easyturk.setOutput(output);
                return true;
            }

      });
    }

    main();
</script>


<script type="text/javascript">
// Define utility functions

    function showServerResponse(response) {
        if (debug_logging) console.log("Showing server response:", response)
        if (debug_logging) console.log("Study type:", study_type)
        var translator_prediction = response[0]
        var answer = response[1]

        if (study_type == "no_translator") {
            show_bot_message(answer)
            dialog_history.push(['bot_answer', answer])
        } else if (study_type == "translator_show_answer") {
            if (translator_prediction == 1) {
              show_bot_message(answer)
              dialog_history.push(['bot_answer', answer])
            } else if (translator_prediction == 0) {
                translator_failure_message = "Sorry, I don't understand this question. Try asking me about something else!"
                show_bot_message(translator_failure_message)
                dialog_history.push(['translator', translator_failure_message])

                answerer_message = "I would have said: "+answer
                show_bot_message(answerer_message)
                dialog_history.push(['bot_answer', answerer_message])
            }
        } else if (study_type == "translator_ask_show_answer") {
            if (translator_prediction == 1) {
              show_bot_message(answer)
              dialog_history.push(['bot_answer', answer])
            } else if (translator_prediction == 0) {
                translator_failure_message = "Sorry, I don't understand this question. Do you want to see my answer anyway?"
                show_bot_message(translator_failure_message)
                dialog_history.push(['translator', translator_failure_message])

                view_answer = true //TODO
                if (view_answer) {
                    answerer_message = "My answer is \""+answer+"\"."
                    show_bot_message(answerer_message)
                    dialog_history.push(['bot_answer', answerer_message])
                }
                
            }
        } else {
            console.log("Invalid study type of :", study_type)
            show_bot_message("This HIT isn't configured right. Exit and send us an email and we'll fix it.")
        }
        
        if (debug_logging) console.log("Done displaying response, returning to image selection.")
        $(".selectImage").removeClass("disabled");
    }

    function getAnswerPlaceholder(jobID) {
        var timeout_id = "";
        var response = null;
        var waited = false;

        var poller = function() {
            if (waited) {
                console.log("returning from poller, stopping spinner");
                end_bot_waiting();
                showServerResponse([1,"placeholder response"]);
                return true;
            } else {
                timeout_id = setTimeout(poller, 3000);
                waited = true;

            }
        
        };
        console.log("calling poller:")
        show_bot_waiting();
        poller();
        console.log("exiting poller.")
    }

    function getAnswer(jobID) {
        var timeout_id = "";
        var response = null;

        var poller = function() {
            // fire another request
            jobID_json = {"job_id":jobID};
            if (debug_logging) console.log("Polling for GET request:", JSON.stringify(jobID_json));

            $.ajax({
                //url:"https://visualgenome.org/hits/get_guess_which_results",
                url: get_endpoint,
                type: "POST",
                data: JSON.stringify(jobID_json),
                dataType: "text",
                contentType: "application/json",
                
                /*
                success: function(data, status, headers, config) {
                    console.log("success function executing, status:")
                    console.log("status:",status)
                    console.log("headers:", headers)
                    console.log("data:", data)
                    if(headers.status === 202) { // "Nay!"
                        console.log("status =  202")
                        console.log(data, status);

                        //spinner.spin();
                        //target = $(".messages")//document.getElementById('foo');
                        //target.appendChild(spinner.el);
                        //console.log("attached spinner")
                    } else if (headers.status === 200){
                        console.log("successful retrieval, status =  200:")
                        console.log(data); //data is a list: [0, '<answer>']; 0 or 1 indicates translator response, string is the answer
                        //clearTimeout(timeout_id);
                        end_bot_waiting();
                        response = data;
                        console.log("parsing server response")
                        showServerResponse(response);
                        return false;
                    } else {
                        console.log("neither")
                    }
                    // continue to call the poller() function every 2 seconds
                    // until the timeout is cancelled
                    console.log("setting timeout")
                    timeout_id = setTimeout(poller, 2000);
                },*/

                success: function(data, textStatus, jqXHR) {
                    if (data == "Nay!") {
                        // bluelagoon isn't ready yet
                        if (debug_logging) console.log("Status 202, not ready, (data, textStatus, jqXHR):", data, textStatus, jqXHR);
                        //console.log("Response not ready yet, setting timeout for 2 seconds.")
                        timeout_id = setTimeout(poller, 2000)
                    } else {
                        if (debug_logging) console.log("GET succeeded, (data, textStatus, jqXHR):", data, textStatus, jqXHR);
                        if (debug_logging) console.log("Parsed data: ", JSON.parse(data))
                        end_bot_waiting();
                        clearTimeout(timeout_id); //not ever necessary?
                        var response = JSON.parse(data)
                        showServerResponse(response)
                        return true
                    }


                    // pre-emptive success function for when VisualGenome.org relays status 202 code from BlueLagoon
                    /*
                    if (jqXHR.status == 202) {
                        console.log("status 202, setting timeout")
                        timeout_id = setTimeout(poller, 2000)
                    } else if (jqXHR.status == 200) {
                        console.log("successful 200")
                        end_bot_waiting();
                        console.log()
                        console.log("parsed data = ", JSON.parse(data))
                        var response = JSON.parse(data)["job_id"]
                        showServerResponse(response)
                        return true
                    }
                    */
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    console.log("Error in retrieving answer: ", errorThrown)

                    end_bot_waiting();
                    show_bot_message("Sorry, there was an error in retrieving the answer to your question. Please try again, and email us if the problem persists.")

                    // Record dialog history and reset current round to account for error
                    current_round = current_round - 1
                    dialog_history.push(['bot_response', '<get_error>'])

                    // set focus back to question box and ask for question again instead of switch to image
                    $("#question").removeAttr("disabled");
                    $("#question").focus();
                    changeQuestionPlaceholder("Start typing question here ...");
                }
            });


            //old .get call, worked when just calling blue lagoon
            /*
            $.get('https://bluelagoon.stanford.edu:5000/get_guess_which_results/'+jobID).
                success(function(data, status, headers, config) {
                    //console.log("success function executing, status:")
                    //console.log("status:",status)
                    //console.log("headers:", headers)
                    //console.log("data:", data)
                    if(headers.status === 202) { // "Nay!"
                        console.log("status =  202")
                        console.log(data, status);

                        //spinner.spin();
                        //target = $(".messages")//document.getElementById('foo');
                        //target.appendChild(spinner.el);
                        //console.log("attached spinner")
                    } else if (headers.status === 200){
                        console.log("successful retrieval, status =  200:")
                        console.log(data); //data is a list: [0, '<answer>']; 0 or 1 indicates translator response, string is the answer
                        //clearTimeout(timeout_id);
                        end_bot_waiting();
                        response = data;
                        console.log("parsing server response")
                        showServerResponse(response);
                        return false;
                    } else {
                        console.log("neither")
                    }
                    // continue to call the poller() function every 2 seconds
                    // until the timeout is cancelled
                    console.log("setting timeout")
                    timeout_id = setTimeout(poller, 2000);
                });
                */
        };
        show_bot_waiting();
        poller();
    }

    function postQuestionGetAnswer(question) {

        post_request = {"img_path": targetImageId+'.jpg',
                        "question": question,
                        "answerer_path": answerer_type,
                        "translator_path": translator_type};

        if (debug_logging) console.log("Posting question:", post_request);
        
        $.ajax({
            //url:"https://visualgenome.org/hits/guess_which",
            url: post_endpoint,
            type: "POST",
            data: JSON.stringify(post_request),
            dataType: "text",
            contentType: "application/json",
            headers: {

            },
            success: function(results) {
                if (debug_logging) console.log("POST succeeded, result:", results);
                getAnswer(results);
            },
            error: function(jqXHR, textStatus, errorThrown) {
                console.log("Error in posting question: ", errorThrown)
                    
                show_bot_message("Sorry, there was an error in posting your question to our servers. Please try again, and email us if the problem persists.")

                // Record dialog history and reset current round to account for error
                current_round = current_round - 1
                dialog_history.push(['bot_response', '<post_error>'])

                // set focus back to question box and ask for question again instead of switch to image
                $("#question").removeAttr("disabled");
                $("#question").focus();
                changeQuestionPlaceholder("Start typing question here ...");
            }
        });
    }


    function show_bot_message(message) {
        var botChatDiv = $('<div class="row chat_bot_row"></div>');
        var botImage = $('<img src="{{static_data_dir}}/images/abot.png" width="40px" height="40px" class="square" align="left">');
        var botColDiv = $('<div class="col s12 l10 left chat_bot"></div>');
        var botCardPanelDiv = $('<div class="card-panel black-text grey lighten-3"></div>');

        $(botCardPanelDiv).prepend('<span class="black-text">' + message + '</span>');
        $(botColDiv).prepend(botCardPanelDiv);
        $(botChatDiv).prepend(botColDiv);
        $(botChatDiv).prepend(botImage);
        $(".messages").append(botChatDiv);
        $.playSound("{{ static_data_dir }}/slack_sound.mp3");
        var wtf = $('.messages');
        var height = wtf[0].scrollHeight;
        wtf.scrollTop(height);
    }

    function show_bot_waiting() {
        spinner.spin();
        var botChatDiv = $('<div class="row chat_bot_row"></div>');
        var botImage = $('<img src="{{static_data_dir}}/images/abot.png" width="40px" height="40px" class="square" align="left">');

        $(botChatDiv).prepend(spinner.el);
        $(botChatDiv).prepend(botImage);
        $(".messages").append(botChatDiv);
        var wtf = $('.messages');
        //console.log("wtf:")
        //console.log(wtf)
        //console.log(wtf[0])
        //console.log(wtf[0].scrollHeight)
        var height = wtf[0].scrollHeight;
        wtf.scrollTop(height);

        pinwheel_bot_chat_div = botChatDiv;
    }

    function end_bot_waiting() {
        spinner.stop();
        pinwheel_bot_chat_div.remove()
        pinwheel_bot_chat_div = null
    }

    function changeQuestionPlaceholder(placeholder) {
        $("#question").attr("placeholder", placeholder);
    }

    function submit() {
        return $("#submit-btn").click();
    }

    /*
    function proceedToNextGame() {         
        
        if (gameId != num_of_games_in_a_hit) {
            // console.log("THIS IS FUCKING WORKING");
            // $("#hitEndModal").modal('open');
            // WONT GO HERE

            location.reload();
        } else {
            console.log("Finished!")
            output = final_output
            if (easyturk.isPreview()) {
                alert("This is only a preview. Here is your output: \n" + JSON.stringify(output));
            return false;
            } else {
                console.log("sending output")
                console.log(output)
                easyturk.setOutput(output);
                $("#submit-btn").click();
                return true;
            }
            //console.log("modal")
            //$("#hitEndModal").modal("open");
        }
    }
    */


</script>


<script type="text/javascript">
// Script to initialize the game

    running_output = {  "pool_index": pool_index,
                        "difficulty_level": difficulty_level,
                        "translator_type": translator_type,
                        "answerer_type": answerer_type,
                        "study_type": study_type,
                        "study_description": study_description,
                        "target_image_id": targetImageId,
                        "dialog_history": dialog_history,
                        "image_selections": image_selections,
                        "final_image_list": final_image_list,
                        "current_in_game_bonus": current_in_game_bonus,
                        "current_finalround_bonus": current_finalround_bonus,
                        "total_payment": total_payment};
    easyturk.setOutput(output);


    if (debug_show_answer) {
        message = "DEBUGGING ONLY:<br> The target image is <img src='{{ target_image }}' height='300px' width='300px'>";
        show_bot_message(message);
    }

    if (debug_logging) console.log("Initially disabling image selection and removing highlighting.")
    $(".selectImage").parent().removeClass("highlight-image");
    $(".selectImage").addClass("disabled");

    $(document).ready(function(){
        if (gameId == 0) {
            //$("#instructionsModal").modal("open");
        }
        // $("#hitEndModal").modal("open");
    });

</script>

<script type="text/javascript">
// Script to define image selection function and question submission function

    $("body").keypress(function(e) {
        var key = e.which;
        var question = $("#question").val();
        if (key == 13 && question != '' && question != null) {
           
            // Change placeholder text and shift focus to selecting image
            message_just_shown = false;
            $("#question").val('');
            $("#question").attr("disabled", "disabled");
            $(".selectImage").addClass("disabled");
            changeQuestionPlaceholder("Click on the image that is your best guess");

            if (current_round == max_rounds) {
                if (debug_logging) console.log("Disabling question after final question submission.");
                $("#question").attr("disabled", "disabled");
            }
            // Create div of the user's message
            var userChatDiv = $('<div class="row chat_row_human"></div>');
            var userColDiv = $('<div class="col s9 l7 right"></div>');
            var userCardPanelDiv = $('<div class="card-panel light-blue darken-4 right"></div>');

            $(userCardPanelDiv).prepend('<span class="white-text"><b>Q:' + (current_round + 1) + "/" + max_rounds + " </b>" + question + '</span>');
            $(userColDiv).prepend(userCardPanelDiv);
            $(userChatDiv).prepend(userColDiv);
            $(".messages").append(userChatDiv);

            // Now scroll to the bottom of the messages
            var wtf = $('.messages');
            var height = wtf[0].scrollHeight;
            wtf.scrollTop(height);

            // Count bonus for correct image guess
            if (current_user_selected_image == targetImageId) {
                current_in_game_bonus += bonus_for_correct_image_after_each_round;
            }

            // Update history to send to server at the end:
            dialog_history.push(["user_question", question]);
            if (current_round > 0) image_selections.push(current_user_selected_image); //skip first question with no image selection

            postQuestionGetAnswer(question)

            // cleanup and setup next turn
            current_user_selected_image = null;        
            current_round += 1;

            running_output = {  "pool_index": pool_index,
                                "difficulty_level": difficulty_level,
                                "translator_type": translator_type,
                                "answerer_type": answerer_type,
                                "study_type": study_type,
                                "study_description": study_description,
                                "target_image_id": targetImageId,
                                "dialog_history": dialog_history,
                                "image_selections": image_selections,
                                "final_image_list": final_image_list,
                                "current_in_game_bonus": current_in_game_bonus,
                                "current_finalround_bonus": current_finalround_bonus,
                                "total_payment": total_payment};
            easyturk.setOutput(output);
            
        }
    });


    $(".selectImage").click(function(){
        if (!$(this).hasClass("disabled")) {
            if (debug_logging) console.log("Selected image. Un-highlighting old selected image")
            if (debug_logging) console.log("Currently selected image id:", $(this).parent().attr('id'));
            $(".selectImage").parent().removeClass("highlight-image");
        
            if (!finalImageSelected) {
                $(this).parent().addClass("highlight-image");
                current_user_selected_image = $(this).parent().attr('id');
                // console.log("CURRENT SELECTED IMAGE IS " + current_user_selected_image);
                changeQuestionPlaceholder("Start typing question here ...");
                
                $("#question").removeAttr("disabled");
                $("#question").focus();
                if (debug_logging) console.log("Not final image selection, so returning focus to question.");

                if (!message_just_shown && current_round != max_rounds) {
                    message = "You can update your guess now. You will get a bonus if you correctly guess the target image. Bonus won will be shown at the end of the game. Once you’re ready, ask me a question! You can only ask me questions (avoid using “Thanks”, “Okay” for example), and please keep your questions relevant to image content, or your work will be rejected."
                    //show_bot_message(message);                    
                }
                message_just_shown = true;

                if (current_round == max_rounds) {
                    if (debug_logging) console.log("Image selected on last round, computing bonus and prompting final guessing procedure.");
                    changeQuestionPlaceholder("Click on the image that is your best guess");

                    if (current_user_selected_image == targetImageId) {
                        current_in_game_bonus += bonus_for_correct_image_after_each_round;
                    }
                    image_selections.push(current_user_selected_image)

                    $("#question").attr("disabled", "disabled");
                    message = "Finally, select your best guess image. If that is not correct, try again."
                    show_bot_message(message);
                    message = "<b>Remember that your bonus depends on how many incorrect guesses you make before you find the target image!</b>"
                    show_bot_message(message);
                    finalImageSelected = true;

                }
            }
            else { // condition where the user is done with all the rounds.

                final_image_list.push($(this).parent().attr('id'));

                if ($(this).parent().attr('id') == targetImageId) {
                    //total_bonus_so_far = total_bonus_so_far + current_bonus;
                    //$("#total_bonus_so_far").text(total_bonus_so_far);
                    //$("#bonus_for_this_game").text(0.0);
                    $("#dialog_guessing_bonus").text(current_in_game_bonus.toFixed(2))
                    $(this).next().show();
                    if (debug_logging) console.log("In final guessing stage, got the right image.")
                   

                    gameId = Number(gameId) + 1;       
                    //next_game_url = updateQueryStringParameter(window.location.href, 'gameId', gameId);
                    // $("#plotModal").modal('open');
                    changeQuestionPlaceholder("Click above button to proceed.");
                    $(".selectImage").attr('style','display:none !important');
                    message = "Thanks for playing the game.<br> The target image is <img src='{{ target_image }}' height='300px' width='300px'>";
                    show_bot_message(message);

                    var number_of_correct_guesses_during_dialog = current_in_game_bonus/bonus_for_correct_image_after_each_round;
                    var total_payment = base_payment + current_in_game_bonus + current_finalround_bonus
                    message = "You earned a base payment of <b>$"+ base_payment.toFixed(2) + "</b>, and on top of that earned <b>$" 
                        + current_in_game_bonus.toFixed(2) + "</b> in additional bonus for guessing the target image correctly after " + 
                        number_of_correct_guesses_during_dialog + " out of " + (max_rounds) + " questions during the dialog. " +
                              "You also earned <b>$" + current_finalround_bonus.toFixed(2) + "</b> in bonus during the final round of guessing. " +
                              "Your total payment is <b>$" + total_payment.toFixed(2) + "</b>."
                    show_bot_message(message);

                    if (gameId == num_of_games_in_a_hit) {
                        message = '<a id="submit-btn-dialog" onClick="submit()" class="btn btn-large blue waves-effect waves-light center">Submit</a>';
                    } else {
                        message = '<a id="submit-btn-dialog" onClick="submit()" class="btn btn-large blue waves-effect waves-light center">Proceed to next game</a>';
                    }
                    show_bot_message(message);
                    $('#submit-btn').prop('disabled', false);

                    final_output = {"pool_index": pool_index,
                                    "difficulty_level": difficulty_level,
                                    "translator_type": translator_type,
                                    "answerer_type": answerer_type,
                                    "study_type": study_type,
                                    "study_description": study_description,
                                    "target_image_id": targetImageId,
                                    "dialog_history": dialog_history,
                                    "image_selections": image_selections,
                                    "final_image_list": final_image_list,
                                    "current_in_game_bonus": current_in_game_bonus,
                                    "current_finalround_bonus": current_finalround_bonus,
                                    "total_payment": total_payment};

                    if (debug_logging) console.log("End-game final output:", final_output)

                } else {
                    $(this).addClass("disabled");
                    $(this).attr('style','display:none !important');
                    $(this).prev().show();
                    current_finalround_bonus = Math.max(0, current_finalround_bonus - bonus_deduction_on_each_click)
                    $("#bonus_for_this_game").text(current_finalround_bonus.toFixed(2));
                    $("#remaining_finalround_bonus").text(current_finalround_bonus.toFixed(2));
                    
                }
            }
        }
    });
</script>


<script>
// Populate completed HIT
//['dialog_history','image_selections','final_image_list','current_in_game_bonus', \
//'current_finalround_bonus', 'total_payment']

    $("#base_payment").text(base_payment.toFixed(2));
    $("#dialog_guessing_bonus").text(completed_hit_output.current_in_game_bonus.toFixed(2));
    $("#remaining_finalround_bonus").text(completed_hit_output.current_finalround_bonus.toFixed(2));

    current_round = -1
    completed_hit_output["dialog_history"].forEach(function (turn, index) {
        speaker = turn[0]
        if (speaker == "user_question") {
            question = turn[1]
            current_round += 1
            // Create div of the user's message
            var userChatDiv = $('<div class="row chat_row_human"></div>');
            var userColDiv = $('<div class="col s9 l7 right"></div>');
            var userCardPanelDiv = $('<div class="card-panel light-blue darken-4 right"></div>');

            $(userCardPanelDiv).prepend('<span class="white-text"><b>Q:' + (current_round + 1) + "/" + max_rounds + " </b>" + question + '</span>');
            $(userColDiv).prepend(userCardPanelDiv);
            $(userChatDiv).prepend(userColDiv);
            $(".messages").append(userChatDiv);

            var guessedImgId = completed_hit_output["image_selections"][current_round]
            var userImgGuess = ("<img src="+(url_prefix+guessedImgId+'.jpg')+" height='150px'>")
            var userChatDivImg = $('<div class="row chat_row_human"></div>');
            var userColDivImg = $('<div class="col s9 l7 right"></div>');
            var userCardPanelDivImg = $('<div class="card-panel light-blue darken-4 right"></div>');
            $(userCardPanelDivImg).prepend('<span class="white-text"><b>Q:' + (current_round + 1) + "/" + max_rounds + " "+userImgGuess+'</span>');
            $(userColDivImg).prepend(userCardPanelDivImg);
            $(userChatDivImg).prepend(userColDivImg);
            $(".messages").append(userChatDivImg);
            //$(".messages").append(userImgGuess);

            // Now scroll to the bottom of the messages
            var wtf = $('.messages');
            var height = wtf[0].scrollHeight;
            wtf.scrollTop(height);

            //message = "DEBUGGING ONLY:<br> The target image is <img src='{{ target_image }}' height='300px' width='300px'>";
            //show_bot_message(message);
        } else if (speaker == "bot_answer") {
            console.log("showing bot answer on round:", current_round)
            message = turn[1]
            show_bot_message(message)
        } else if (speaker == "translator") {
            console.log("Translator display not configured yet.")
        } else {
            console.log("Unrecognized speaker in dialog history: ", speaker)
        }

    });

    console.log("Image selections:", completed_hit_output["image_selections"])

    // Disable question field
    $("#question").attr("disabled", "disabled");
    changeQuestionPlaceholder("View the completed dialog");

    // Highlight target image
    $("#"+targetImageId).addClass("highlight-green")

    // Show guessed images
    completed_hit_output["final_image_list"].forEach(function (imageId, index) {
        if (imageId == targetImageId) {
            $("#"+imageId).children().eq(3).addClass("disabled");
            $("#"+imageId).children().eq(3).attr('style','display:none !important');
            $("#"+imageId).children().eq(4).show();
        
            var number = $('<strong class="large center green-text number_icon" style="display: inline;">'+(index+1)+'</strong>')
            $("#"+imageId).append(number)
        } else {
            $("#"+imageId).children().eq(3).addClass("disabled");
            $("#"+imageId).children().eq(3).attr('style','display:none !important');
            $("#"+imageId).children().eq(2).show();
            var number = $('<strong class="large center red-text number_icon" style="display: inline;">'+(index+1)+'</strong>')
            $("#"+imageId).append(number)
        }
    });


    /*
    var number = $('<!-- Create an icon wrapped by the fa-stack class -->\
                    <span class="fa-stack large center red-text number_icon" style="display: inline;">\
                        <!-- The icon that will wrap the number -->\
                        <span class="fa fa-circle-o fa-stack-2x"></span>\
                        <!-- a strong element with the custom content, in this case a number -->\
                        <strong class="fa-stack-1x">\
                            2\
                        </strong>\
                    </span>');*/





</script>



{% endblock %}
